<!DOCTYPE html>
<html>

<head>
    <!-- meta tags -->
    <meta charset="utf-8">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <title>Incident Trends</title>
    <link href="styles/mainStyle.css" rel="stylesheet" type="text/css">
    <script crossorigin="anonymous" src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>
    <script src="js/main.js"></script>
    
</head>
<body>
        <div class="chart-container">
                <canvas id="chart"></canvas>
            </div>
    <script>

    var loadIncidentsToTrendsPage = function () {

        $.ajax({
            type: "GET",
            contentType: "application/json",
            url: "http://localhost:8080/trend",
            success: function (trends, textStatus, jqXHR) {
                //trends json format:
                //a list of dictionaries of dictionaries, as seen below:
                // [
                //     {
                //         "incidentTypeDescription":"Car Crash",
                //         "totalPerMonth":{
                //             "03-2018":34, "04-2018":36, "05-2018":39, "06-2018":40, "07-2018":50, "08-2018":42,
                //             "09-2018":39, "10-2018":31, "11-2018":36, "12-2018":21, "01-2019":21, "02-2019":2 }
                //     },
                //     {
                //         "incidentTypeDescription":"Faulty Traffic Light",
                //         "totalPerMonth":{
                //             "03-2018":40, "04-2018":35, "05-2018":36, "06-2018":41, "07-2018":49, "08-2018":43,
                //             "09-2018":30, "10-2018":27, "11-2018":41, "12-2018":39, "01-2019":6, "02-2019":1 }
                //     },
                // ...
                //]
                plotTrendsChart(trends);
            },
            error: function (jqXHR, textStatus, errorThrown) {
                alert('incidents load chart error: textStatus: ' + textStatus + ' | jqXHR.status: ' + jqXHR.status + ' | errorThrown: ' + errorThrown);
            }
        });
    };



    var availableColors = [
        "rgba(0,0,0,255)", "rgba(255,0,0,255)", "rgba(0,0,255,255)",
        "rgba(0,255,0,255)", "rgba(255,255,0,255)", "rgba(0,255,255,255)"
    ];

    function addLabels(targetDictionary, trendsData) {
        targetDictionary['labels'] = Object.keys(trendsData[0]["totalPerMonth"]);
    }

    function addIncidents(chartData, trendsData) {
        var numberOfIncidentTypes = trendsData.length;
        var datasets = [];
        for (var index = 0; index < numberOfIncidentTypes; index++) {
            var incidentTypeChartData = {};
            incidentTypeChartData["label"] = trendsData[index]["incidentTypeDescription"];
            incidentTypeChartData["backgroundColor"] = "rgba(0,0,0,0)";
            incidentTypeChartData["borderColor"] = availableColors[index];
            incidentTypeChartData["borderWidth"] = "2";
            incidentTypeChartData["hoverBackgroundColor"] = "rgba(255,99,132,0.4)";
            incidentTypeChartData["hoverBorderColor"] = "rgba(255,99,132,1)";
            incidentTypeChartData["data"] = Object.values(trendsData[index]["totalPerMonth"]);
            incidentTypeChartData["type"] = "line";
            datasets.push(incidentTypeChartData);
        }
        chartData["datasets"] = datasets;
    }

    function plotTrendsChart(trendsData) {
        var chartData = {};
        addLabels(chartData, trendsData);
        addIncidents(chartData, trendsData);

        var chartOptions = {
            responsive: 'true',
            maintainAspectRatio: false,
            scales: {
                yAxes: [{
                    gridLines: {
                        display: true,
                        color: "rgba(255,99,132,0.2)"
                    }
                }],
                xAxes: [{
                    gridLines: {
                        display: false
                    }
                }]
            }
        };

        Chart.Bar('chart', {
            options: chartOptions,
            data: chartData
        });
    }

    $(document).ready(function () {
        loadIncidentsToTrendsPage();
    });

    </script>
</body>
</html>
